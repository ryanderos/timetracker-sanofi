<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTracker Pro - Sanofi</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B5A96">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TimeTracker Pro">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgcng9IjIwIiBmaWxsPSIjOEI1QTk2Ii8+PHRleHQgeD0iOTYiIHk9IjEwNSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7ijqE8L3RleHQ+PC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMTkyIDE5MiI+PHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgcng9IjIwIiBmaWxsPSIjOEI1QTk2Ii8+PHRleHQgeD0iOTYiIHk9IjEwNSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7ijqE8L3RleHQ+PC9zdmc+">>
    <style>
        :root {
            --sanofi-purple: #8B5A96;
            --sanofi-purple-dark: #6B4476;
            --sanofi-purple-light: #B087C4;
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --gray-medium: #e9ecef;
            --gray-dark: #495057;
            --green: #28a745;
            --red: #dc3545;
            --blue: #007bff;
        }

        [data-theme="dark"] {
            --white: #1a1a1a;
            --gray-light: #2d2d2d;
            --gray-medium: #3d3d3d;
            --gray-dark: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--sanofi-purple-light) 0%, var(--sanofi-purple) 100%);
            min-height: 100vh;
            color: var(--gray-dark);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(139, 90, 150, 0.3);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: var(--sanofi-purple);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: var(--gray-light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--sanofi-purple);
            color: var(--white);
            transform: scale(1.1);
        }

        .main-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(139, 90, 150, 0.2);
        }

        .punch-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .punch-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .punch-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .punch-btn:hover:before {
            left: 100%;
        }

        .punch-btn.start {
            background: var(--sanofi-purple);
            color: var(--white);
        }

        .punch-btn.end {
            background: var(--gray-medium);
            color: var(--gray-dark);
        }

        .punch-btn.active {
            background: var(--green);
            color: var(--white);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .break-section {
            border-top: 1px solid var(--gray-medium);
            padding-top: 20px;
            margin-top: 20px;
        }

        .break-title {
            text-align: center;
            color: var(--sanofi-purple);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--sanofi-purple-light), var(--sanofi-purple));
            color: var(--white);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(139, 90, 150, 0.3);
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .menu-item {
            background: var(--white);
            border: none;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 16px rgba(139, 90, 150, 0.2);
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(139, 90, 150, 0.3);
        }

        .menu-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--sanofi-purple);
        }

        .menu-text {
            font-size: 14px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--white);
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            animation: modalShow 0.3s ease;
        }

        @keyframes modalShow {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-medium);
        }

        .modal-title {
            color: var(--sanofi-purple);
            font-size: 20px;
            font-weight: bold;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--sanofi-purple);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-medium);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--sanofi-purple);
        }

        .btn {
            background: var(--sanofi-purple);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--sanofi-purple-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-medium);
            color: var(--gray-dark);
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
            color: var(--white);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--gray-medium);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: var(--sanofi-purple-light);
            color: var(--white);
        }

        .calendar-day.today {
            background: var(--sanofi-purple);
            color: var(--white);
        }

        .calendar-day.has-hours {
            border-color: var(--sanofi-purple);
            background: var(--sanofi-purple-light);
            color: var(--white);
        }

        .tutorial-step {
            background: var(--gray-light);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--sanofi-purple);
        }

        .tutorial-step h3 {
            color: var(--sanofi-purple);
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-working {
            background: var(--green);
            animation: pulse 2s infinite;
        }

        .status-break {
            background: var(--blue);
        }

        .status-off {
            background: var(--gray-medium);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-medium);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sanofi-purple), var(--sanofi-purple-light));
            transition: width 0.3s ease;
        }

        .constraint-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid var(--sanofi-purple);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .constraint-remove {
            background: var(--red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">‚ö° TimeTracker Pro</div>
            <div class="header-controls">
                <button class="icon-btn" id="cloudBtn" title="Sauvegarde Cloud">‚òÅÔ∏è</button>
                <button class="icon-btn" id="themeBtn" title="Mode Sombre">üåô</button>
            </div>
        </div>

        <!-- Main Punch Card -->
        <div class="main-card">
            <!-- Status -->
            <div style="text-align: center; margin-bottom: 20px;">
                <span class="status-indicator status-off" id="statusIndicator"></span>
                <span id="statusText">Hors service</span>
            </div>

            <!-- Punch Buttons -->
            <div class="punch-buttons">
                <button class="punch-btn start" id="startBtn">
                    <div>üü£ ARRIV√âE</div>
                    <small id="startTime"></small>
                </button>
                <button class="punch-btn end" id="endBtn">
                    <div>‚ö™ D√âPART</div>
                    <small id="endTime"></small>
                </button>
            </div>

            <!-- Break Section -->
            <div class="break-section">
                <div class="break-title">‚è∏Ô∏è Gestion des Pauses</div>
                <div class="punch-buttons">
                    <button class="punch-btn start" id="breakStartBtn">
                        <div>üü£ PAUSE</div>
                        <small id="breakStartTime"></small>
                    </button>
                    <button class="punch-btn end" id="breakEndBtn">
                        <div>‚ö™ FIN PAUSE</div>
                        <small id="breakEndTime"></small>
                    </button>
                </div>
            </div>

            <!-- Current Day Progress -->
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Progr√®s du jour</span>
                    <span id="dayProgress">0h00 / 7h00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="dayProgressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="main-card">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="todayHours">0h00</div>
                    <div class="stat-label">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weekHours">0h00/35h</div>
                    <div class="stat-label">Cette semaine</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="remainingHours">35h00</div>
                    <div class="stat-label">Restant</div>
                </div>
            </div>
        </div>

        <!-- Menu Grid -->
        <div class="main-card">
            <div class="menu-grid">
                <button class="menu-item" id="aiPlannerBtn">
                    <div class="menu-icon">ü§ñ</div>
                    <div class="menu-text">Planning IA</div>
                </button>
                <button class="menu-item" id="calendarBtn">
                    <div class="menu-icon">üìÖ</div>
                    <div class="menu-text">Calendrier</div>
                </button>
                <button class="menu-item" id="exportBtn">
                    <div class="menu-icon">üìä</div>
                    <div class="menu-text">Export Excel</div>
                </button>
                <button class="menu-item" id="statsBtn">
                    <div class="menu-icon">üìà</div>
                    <div class="menu-text">Statistiques</div>
                </button>
                <button class="menu-item" id="settingsBtn">
                    <div class="menu-icon">‚öôÔ∏è</div>
                    <div class="menu-text">Param√®tres</div>
                </button>
                <button class="menu-item" id="tutorialBtn">
                    <div class="menu-icon">‚ùì</div>
                    <div class="menu-text">Tutorial</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- AI Planner Modal -->
    <div id="aiPlannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ü§ñ Planificateur IA</h2>
                <button class="close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Ajouter une contrainte :</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <select class="form-input" id="constraintDay">
                        <option value="">Jour</option>
                        <option value="lundi">Lundi</option>
                        <option value="mardi">Mardi</option>
                        <option value="mercredi">Mercredi</option>
                        <option value="jeudi">Jeudi</option>
                        <option value="vendredi">Vendredi</option>
                    </select>
                    <select class="form-input" id="constraintType">
                        <option value="">Type de contrainte</option>
                        <option value="early_leave">D√©part anticip√©</option>
                        <option value="late_arrival">Arriv√©e tardive</option>
                        <option value="long_break">Pause longue</option>
                        <option value="short_day">Journ√©e courte</option>
                    </select>
                    <input type="time" class="form-input" id="constraintTime" placeholder="Heure">
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-input" id="constraintReason" placeholder="Raison (ex: RDV m√©decin, formation...)" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" id="addConstraintBtn">‚ûï Ajouter</button>
                </div>
                
                <div id="constraintsList" style="background: var(--gray-light); padding: 10px; border-radius: 8px; min-height: 50px;">
                    <div style="color: var(--gray-dark); font-size: 14px; font-style: italic;">Aucune contrainte ajout√©e</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Heures d√©j√† effectu√©es cette semaine :</label>
                <input type="number" class="form-input" id="currentWeekHours" placeholder="0" step="0.5" min="0" max="35">
            </div>
            <button class="btn" id="generatePlanningBtn">üöÄ G√©n√©rer le Planning</button>
            <div id="planningResult" style="margin-top: 20px; display: none;">
                <h3 style="color: var(--sanofi-purple); margin-bottom: 15px;">üìã Planning Optimis√© :</h3>
                <div id="planningContent"></div>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìÖ Calendrier</h2>
                <button class="close">&times;</button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-secondary" id="prevMonth">‚óÄ</button>
                <span id="currentMonth" style="margin: 0 20px; font-weight: bold; color: var(--sanofi-purple);"></span>
                <button class="btn btn-secondary" id="nextMonth">‚ñ∂</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div id="dayDetails" style="margin-top: 20px; display: none;">
                <h3 style="color: var(--sanofi-purple);">D√©tails du jour :</h3>
                <div id="dayDetailsContent"></div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Export Excel</h2>
                <button class="close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">P√©riode d'export :</label>
                <select class="form-input" id="exportPeriod">
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois</option>
                    <option value="custom">P√©riode personnalis√©e</option>
                </select>
            </div>
            <div id="customPeriod" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Du :</label>
                    <input type="date" class="form-input" id="exportDateFrom">
                </div>
                <div class="form-group">
                    <label class="form-label">Au :</label>
                    <input type="date" class="form-input" id="exportDateTo">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="downloadExcelBtn">üíæ T√©l√©charger Excel</button>
                <button class="btn btn-secondary" id="previewDataBtn">üëÅÔ∏è Aper√ßu</button>
            </div>
            <div id="dataPreview" style="margin-top: 20px; display: none;">
                <h3 style="color: var(--sanofi-purple);">Aper√ßu des donn√©es :</h3>
                <div id="previewContent"></div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìà Vos Statistiques</h2>
                <button class="close">&times;</button>
            </div>
            <div id="personalStats">
                <div style="background: var(--gray-light); padding: 15px; border-radius: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--sanofi-purple);" id="totalDaysWorked">0</div>
                            <div style="font-size: 12px;">Jours travaill√©s</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--sanofi-purple);" id="averageDailyHours">0h00</div>
                            <div style="font-size: 12px;">Moyenne/jour</div>
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: var(--sanofi-purple); margin-bottom: 10px;">üìä Progression mensuelle</h4>
                        <div id="monthlyProgress"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ùì Guide d'utilisation</h2>
                <button class="close">&times;</button>
            </div>
            <div class="tutorial-step">
                <h3>1. üïò Pointer son arriv√©e</h3>
                <p>Cliquez sur le bouton violet "ARRIV√âE" d√®s votre arriv√©e au travail. L'heure sera automatiquement enregistr√©e.</p>
            </div>
            <div class="tutorial-step">
                <h3>2. ‚è∏Ô∏è G√©rer les pauses</h3>
                <p>Utilisez les boutons "PAUSE" et "FIN PAUSE" pour d√©compter automatiquement vos temps de pause du midi.</p>
            </div>
            <div class="tutorial-step">
                <h3>3. üïï Pointer son d√©part</h3>
                <p>N'oubliez pas de cliquer sur "D√âPART" en partant. Vos heures seront automatiquement calcul√©es.</p>
            </div>
            <div class="tutorial-step">
                <h3>4. ü§ñ Utiliser le Planning IA</h3>
                <p>Ajoutez vos contraintes avec les menus d√©roulants et l'IA vous proposera un planning optimal pour atteindre 35h.</p>
            </div>
            <div class="tutorial-step">
                <h3>5. ‚úèÔ∏è Rectifier vos horaires</h3>
                <p>Param√®tres ‚Üí "Modifier les horaires du jour" pour corriger n'importe quel jour pass√© ou futur.</p>
            </div>
            <div class="tutorial-step">
                <h3>6. üìä Consulter vos statistiques</h3>
                <p>Visualisez vos performances personnelles : jours travaill√©s, moyenne quotidienne, progression mensuelle.</p>
            </div>
            <div class="tutorial-step">
                <h3>7. ‚òÅÔ∏è Sauvegarde Cloud</h3>
                <p>Activez la sauvegarde cloud pour pr√©parer vos donn√©es √† l'export vers vos comptes personnels.</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Param√®tres</h2>
                <button class="close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Notifications :</label>
                <label><input type="checkbox" id="notificationsEnabled"> Activer les notifications</label>
            </div>
            <div class="form-group">
                <label class="form-label">Heures de travail par jour :</label>
                <input type="number" class="form-input" id="dailyHours" value="7" step="0.5" min="1" max="12">
            </div>
            <div class="form-group">
                <label class="form-label">Objectif hebdomadaire :</label>
                <input type="number" class="form-input" id="weeklyGoal" value="35" step="0.5" min="1" max="50">
            </div>
            <div class="form-group">
                <label class="form-label">Rectification d'horaires :</label>
                <button class="btn btn-secondary" id="editTimesBtn">‚úèÔ∏è Modifier les horaires</button>
            </div>
            <button class="btn" id="saveSettingsBtn">üíæ Sauvegarder</button>
        </div>
    </div>

    <!-- Edit Times Modal -->
    <div id="editTimesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Rectification d'horaires</h2>
                <button class="close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Date √† modifier :</label>
                <input type="date" class="form-input" id="editDate">
            </div>
            <div class="form-group">
                <label class="form-label">Heure d'arriv√©e :</label>
                <input type="time" class="form-input" id="editStartTime">
            </div>
            <div class="form-group">
                <label class="form-label">Heure de d√©part :</label>
                <input type="time" class="form-input" id="editEndTime">
            </div>
            <div class="form-group">
                <label class="form-label">D√©but pause :</label>
                <input type="time" class="form-input" id="editBreakStart">
            </div>
            <div class="form-group">
                <label class="form-label">Fin pause :</label>
                <input type="time" class="form-input" id="editBreakEnd">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="saveEditBtn">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" id="loadDayBtn">üì• Charger le jour</button>
            </div>
        </div>
    </div>

    <script>
        class TimeTrackerApp {
            constructor() {
                this.workStatus = 'off';
                this.startTime = null;
                this.endTime = null;
                this.breakStartTime = null;
                this.breakEndTime = null;
                this.dailyHours = 7;
                this.weeklyGoal = 35;
                this.constraints = [];
                this.notified7Hours = false;
                this.notifiedBreak = false;
                
                this.initializeApp();
                this.bindEvents();
                this.updateDisplay();
                this.requestNotificationPermission();
            }

            initializeApp() {
                this.loadData();
                this.updateDisplay();
                this.checkWorkSession();
                setInterval(() => this.updateDisplay(), 1000);
            }

            loadData() {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const today = new Date().toISOString().split('T')[0];
                const todayData = data[today] || {};
                
                this.startTime = todayData.startTime ? new Date(todayData.startTime) : null;
                this.endTime = todayData.endTime ? new Date(todayData.endTime) : null;
                this.breakStartTime = todayData.breakStartTime ? new Date(todayData.breakStartTime) : null;
                this.breakEndTime = todayData.breakEndTime ? new Date(todayData.breakEndTime) : null;
                
                const settings = JSON.parse(localStorage.getItem('timeTrackerSettings') || '{}');
                this.dailyHours = settings.dailyHours || 7;
                this.weeklyGoal = settings.weeklyGoal || 35;
                
                this.updateWorkStatus();
            }

            saveData() {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const today = new Date().toISOString().split('T')[0];
                
                data[today] = {
                    startTime: this.startTime?.toISOString(),
                    endTime: this.endTime?.toISOString(),
                    breakStartTime: this.breakStartTime?.toISOString(),
                    breakEndTime: this.breakEndTime?.toISOString(),
                    totalHours: this.calculateTodayHours(),
                    breakHours: this.calculateBreakHours()
                };
                
                localStorage.setItem('timeTrackerData', JSON.stringify(data));
            }

            updateWorkStatus() {
                if (this.startTime && !this.endTime) {
                    if (this.breakStartTime && !this.breakEndTime) {
                        this.workStatus = 'break';
                    } else {
                        this.workStatus = 'working';
                    }
                } else {
                    this.workStatus = 'off';
                }
            }

            checkWorkSession() {
                if (this.startTime && !this.endTime) {
                    const now = new Date();
                    const workHours = (now - this.startTime) / (1000 * 60 * 60);
                    
                    if (workHours > 10) {
                        this.showNotification('‚ö†Ô∏è Attention', 'Vous travaillez depuis plus de 10 heures !');
                    }
                }
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => this.handleStart());
                document.getElementById('endBtn').addEventListener('click', () => this.handleEnd());
                document.getElementById('breakStartBtn').addEventListener('click', () => this.handleBreakStart());
                document.getElementById('breakEndBtn').addEventListener('click', () => this.handleBreakEnd());

                document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());
                document.getElementById('cloudBtn').addEventListener('click', () => this.toggleCloudSync());

                document.getElementById('aiPlannerBtn').addEventListener('click', () => this.openModal('aiPlannerModal'));
                document.getElementById('calendarBtn').addEventListener('click', () => this.openCalendar());
                document.getElementById('exportBtn').addEventListener('click', () => this.openModal('exportModal'));
                document.getElementById('statsBtn').addEventListener('click', () => this.openStats());
                document.getElementById('settingsBtn').addEventListener('click', () => this.openModal('settingsModal'));
                document.getElementById('tutorialBtn').addEventListener('click', () => this.openModal('tutorialModal'));

                document.querySelectorAll('.modal .close').forEach(btn => {
                    btn.addEventListener('click', () => this.closeAllModals());
                });

                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) this.closeAllModals();
                    });
                });

                document.getElementById('generatePlanningBtn').addEventListener('click', () => this.generatePlanning());
                document.getElementById('addConstraintBtn').addEventListener('click', () => this.addConstraint());

                document.getElementById('exportPeriod').addEventListener('change', (e) => {
                    document.getElementById('customPeriod').style.display = 
                        e.target.value === 'custom' ? 'block' : 'none';
                });
                document.getElementById('downloadExcelBtn').addEventListener('click', () => this.downloadExcel());
                document.getElementById('previewDataBtn').addEventListener('click', () => this.previewData());

                document.getElementById('saveSettingsBtn').addEventListener('click', () => this.saveSettings());
                document.getElementById('editTimesBtn').addEventListener('click', () => this.openEditTimes());

                document.getElementById('prevMonth').addEventListener('click', () => this.navigateCalendar(-1));
                document.getElementById('nextMonth').addEventListener('click', () => this.navigateCalendar(1));

                document.getElementById('loadDayBtn').addEventListener('click', () => this.loadDayForEdit());
                document.getElementById('saveEditBtn').addEventListener('click', () => this.saveEditedTimes());
            }

            handleStart() {
                if (this.workStatus === 'off') {
                    this.startTime = new Date();
                    this.endTime = null;
                    this.workStatus = 'working';
                    this.saveData();
                    this.updateDisplay();
                    this.showNotification('‚úÖ Arriv√©e enregistr√©e', `Bon travail ! Point√© √† ${this.formatTime(this.startTime)}`);
                }
            }

            handleEnd() {
                if (this.workStatus === 'working' || this.workStatus === 'break') {
                    if (this.workStatus === 'break') {
                        this.handleBreakEnd();
                    }
                    
                    this.endTime = new Date();
                    this.workStatus = 'off';
                    this.saveData();
                    this.updateDisplay();
                    
                    const totalHours = this.calculateTodayHours();
                    this.showNotification('üèÅ D√©part enregistr√©', `Journ√©e termin√©e ! ${totalHours.toFixed(2)}h travaill√©es`);
                }
            }

            handleBreakStart() {
                if (this.workStatus === 'working') {
                    this.breakStartTime = new Date();
                    this.breakEndTime = null;
                    this.workStatus = 'break';
                    this.saveData();
                    this.updateDisplay();
                    this.showNotification('‚è∏Ô∏è Pause commenc√©e', 'Bon app√©tit !');
                }
            }

            handleBreakEnd() {
                if (this.workStatus === 'break') {
                    this.breakEndTime = new Date();
                    this.workStatus = 'working';
                    this.saveData();
                    this.updateDisplay();
                    
                    const breakDuration = (this.breakEndTime - this.breakStartTime) / (1000 * 60);
                    this.showNotification('‚ñ∂Ô∏è Pause termin√©e', `Pause de ${Math.round(breakDuration)} minutes`);
                }
            }

            calculateTodayHours() {
                if (!this.startTime) return 0;
                
                const endTime = this.endTime || new Date();
                let totalMinutes = (endTime - this.startTime) / (1000 * 60);
                
                if (this.breakStartTime) {
                    const breakEnd = this.breakEndTime || new Date();
                    const breakMinutes = (breakEnd - this.breakStartTime) / (1000 * 60);
                    totalMinutes -= breakMinutes;
                }
                
                return Math.max(0, totalMinutes / 60);
            }

            calculateBreakHours() {
                if (!this.breakStartTime) return 0;
                
                const breakEnd = this.breakEndTime || new Date();
                return (breakEnd - this.breakStartTime) / (1000 * 60 * 60);
            }

            calculateWeekHours() {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay() + 1);
                startOfWeek.setHours(0, 0, 0, 0);
                
                let totalHours = 0;
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    if (data[dateStr]) {
                        totalHours += data[dateStr].totalHours || 0;
                    }
                }
                
                return totalHours;
            }

            updateDisplay() {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                statusIndicator.className = 'status-indicator';
                switch (this.workStatus) {
                    case 'working':
                        statusIndicator.classList.add('status-working');
                        statusText.textContent = 'En service';
                        break;
                    case 'break':
                        statusIndicator.classList.add('status-break');
                        statusText.textContent = 'En pause';
                        break;
                    default:
                        statusIndicator.classList.add('status-off');
                        statusText.textContent = 'Hors service';
                }

                this.updateButtonStates();
                this.updateTimesDisplay();
                this.updateStats();
                this.updateProgressBar();
            }

            updateButtonStates() {
                const startBtn = document.getElementById('startBtn');
                const endBtn = document.getElementById('endBtn');
                const breakStartBtn = document.getElementById('breakStartBtn');
                const breakEndBtn = document.getElementById('breakEndBtn');

                [startBtn, endBtn, breakStartBtn, breakEndBtn].forEach(btn => {
                    btn.classList.remove('active');
                });

                switch (this.workStatus) {
                    case 'working':
                        startBtn.classList.add('active');
                        break;
                    case 'break':
                        breakStartBtn.classList.add('active');
                        break;
                }
            }

            updateTimesDisplay() {
                document.getElementById('startTime').textContent = 
                    this.startTime ? this.formatTime(this.startTime) : '';
                document.getElementById('endTime').textContent = 
                    this.endTime ? this.formatTime(this.endTime) : '';
                document.getElementById('breakStartTime').textContent = 
                    this.breakStartTime ? this.formatTime(this.breakStartTime) : '';
                document.getElementById('breakEndTime').textContent = 
                    this.breakEndTime ? this.formatTime(this.breakEndTime) : '';
            }

            updateStats() {
                const todayHours = this.calculateTodayHours();
                const weekHours = this.calculateWeekHours();
                const remainingHours = Math.max(0, this.weeklyGoal - weekHours);

                document.getElementById('todayHours').textContent = this.formatHours(todayHours);
                document.getElementById('weekHours').textContent = `${this.formatHours(weekHours)}/${this.weeklyGoal}h`;
                document.getElementById('remainingHours').textContent = this.formatHours(remainingHours);
            }

            updateProgressBar() {
                const todayHours = this.calculateTodayHours();
                const progress = Math.min(100, (todayHours / this.dailyHours) * 100);
                
                document.getElementById('dayProgress').textContent = 
                    `${this.formatHours(todayHours)} / ${this.dailyHours}h00`;
                document.getElementById('dayProgressBar').style.width = `${progress}%`;
            }

            formatTime(date) {
                return date.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            formatHours(hours) {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${h}h${m.toString().padStart(2, '0')}`;
            }

            openModal(modalId) {
                this.closeAllModals();
                document.getElementById(modalId).style.display = 'block';
                
                if (modalId === 'settingsModal') {
                    this.loadSettingsModal();
                }
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            toggleTheme() {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                const themeBtn = document.getElementById('themeBtn');
                themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            toggleCloudSync() {
                const cloudBtn = document.getElementById('cloudBtn');
                const isEnabled = cloudBtn.classList.contains('enabled');
                
                if (!isEnabled) {
                    const explanation = `
üåü SAUVEGARDE CLOUD - COMMENT √áA MARCHE

üìã DONN√âES STOCK√âES LOCALEMENT :
‚Ä¢ Toutes vos donn√©es restent sur VOTRE appareil
‚Ä¢ Aucun serveur externe = 100% GRATUIT
‚Ä¢ Confidentialit√© totale garantie

‚òÅÔ∏è "CLOUD" = SAUVEGARDE LOCALE RENFORC√âE :
‚Ä¢ Export automatique vers votre stockage perso
‚Ä¢ Synchronisation entre vos appareils via vos propres comptes
‚Ä¢ Vous gardez le contr√¥le total de vos donn√©es

‚úÖ ACTIVATION :
Cette fonction pr√©pare vos donn√©es pour l'export automatique vers votre Google Drive, Dropbox, etc.
                    `;
                    
                    if (confirm(explanation + '\n\nActiver la pr√©paration cloud ?')) {
                        cloudBtn.classList.add('enabled');
                        cloudBtn.style.background = 'var(--green)';
                        cloudBtn.style.color = 'var(--white)';
                        this.showNotification('‚òÅÔ∏è Cloud pr√©par√©', 'Donn√©es pr√™tes pour export automatique');
                    }
                } else {
                    cloudBtn.classList.remove('enabled');
                    cloudBtn.style.background = '';
                    cloudBtn.style.color = '';
                    this.showNotification('‚òÅÔ∏è Cloud d√©sactiv√©', 'Stockage local uniquement');
                }
            }

            // AI Planning with structured constraints
            addConstraint() {
                const day = document.getElementById('constraintDay').value;
                const type = document.getElementById('constraintType').value;
                const time = document.getElementById('constraintTime').value;
                const reason = document.getElementById('constraintReason').value.trim();
                
                if (!day || !type || !time) {
                    this.showNotification('‚ùå Erreur', 'Veuillez remplir tous les champs');
                    return;
                }
                
                const constraint = {
                    id: Date.now(),
                    day: day,
                    type: type,
                    time: time,
                    reason: reason || 'Sans motif'
                };
                
                this.constraints.push(constraint);
                this.updateConstraintsList();
                
                document.getElementById('constraintDay').value = '';
                document.getElementById('constraintType').value = '';
                document.getElementById('constraintTime').value = '';
                document.getElementById('constraintReason').value = '';
                
                this.showNotification('‚úÖ Contrainte ajout√©e', `${day} - ${this.getConstraintTypeLabel(type)}`);
            }

            removeConstraint(id) {
                this.constraints = this.constraints.filter(c => c.id !== id);
                this.updateConstraintsList();
                this.showNotification('üóëÔ∏è Contrainte supprim√©e', 'Contrainte retir√©e du planning');
            }

            updateConstraintsList() {
                const listDiv = document.getElementById('constraintsList');
                
                if (this.constraints.length === 0) {
                    listDiv.innerHTML = '<div style="color: var(--gray-dark); font-size: 14px; font-style: italic;">Aucune contrainte ajout√©e</div>';
                    return;
                }
                
                let html = '';
                this.constraints.forEach(constraint => {
                    const typeLabel = this.getConstraintTypeLabel(constraint.type);
                    html += `
                        <div class="constraint-item">
                            <div>
                                <strong>${constraint.day.charAt(0).toUpperCase() + constraint.day.slice(1)}</strong> - 
                                ${typeLabel} √† ${constraint.time}<br>
                                <small style="color: var(--gray-dark);">${constraint.reason}</small>
                            </div>
                            <button class="constraint-remove" onclick="window.timeTracker.removeConstraint(${constraint.id})">√ó</button>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
            }

            getConstraintTypeLabel(type) {
                const labels = {
                    'early_leave': 'D√©part anticip√©',
                    'late_arrival': 'Arriv√©e tardive',
                    'long_break': 'Pause longue',
                    'short_day': 'Journ√©e courte'
                };
                return labels[type] || type;
            }

            generatePlanning() {
                const currentHours = parseFloat(document.getElementById('currentWeekHours').value) || 0;
                const remainingHours = this.weeklyGoal - currentHours;
                
                if (remainingHours <= 0) {
                    document.getElementById('planningResult').style.display = 'block';
                    document.getElementById('planningContent').innerHTML = 
                        '<div style="color: var(--green); font-weight: bold;">‚úÖ Objectif hebdomadaire d√©j√† atteint !</div>';
                    return;
                }
                
                const daysRemaining = this.getRemainingWorkDays();
                
                let planning = '<div style="background: var(--gray-light); padding: 15px; border-radius: 10px;">';
                planning += `<div style="margin-bottom: 10px;"><strong>üìä Analyse :</strong></div>`;
                planning += `<div>‚Ä¢ Heures restantes : ${remainingHours.toFixed(1)}h</div>`;
                planning += `<div>‚Ä¢ Jours restants : ${daysRemaining}</div>`;
                planning += `<div>‚Ä¢ Contraintes actives : ${this.constraints.length}</div>`;
                planning += '</div>';
                
                planning += '<div style="margin-top: 15px;"><strong>üìÖ Planning d√©taill√© sugg√©r√© :</strong></div>';
                
                const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
                const today = new Date().getDay();
                let totalPlannedHours = 0;
                
                for (let i = 1; i <= 5; i++) {
                    if (i < today) continue;
                    
                    const dayName = days[i - 1];
                    const dayConstraints = this.constraints.filter(c => c.day === dayName);
                    
                    let daySchedule = '';
                    let plannedHours = 7;
                    
                    if (dayConstraints.length > 0) {
                        const constraint = dayConstraints[0];
                        
                        if (constraint.type === 'early_leave') {
                            plannedHours = this.calculateHoursBetween('08:00', constraint.time) - 1;
                            
                            daySchedule = `
                                <div style="margin: 5px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid orange;">
                                    <strong>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</strong> - ${constraint.reason} ‚ö†Ô∏è<br>
                                    üïó <strong>Arriv√©e :</strong> 08:00<br>
                                    ‚è∏Ô∏è <strong>Pause :</strong> 12:00 - 13:00<br>
                                    üïí <strong>D√©part :</strong> ${constraint.time}<br>
                                    ‚è±Ô∏è <strong>Total :</strong> ${plannedHours.toFixed(1)}h
                                </div>
                            `;
                        } else if (constraint.type === 'late_arrival') {
                            plannedHours = 7;
                            const endTime = this.addHoursToTime(constraint.time, 8);
                            
                            daySchedule = `
                                <div style="margin: 5px 0; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid orange;">
                                    <strong>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</strong> - ${constraint.reason} ‚ö†Ô∏è<br>
                                    üïò <strong>Arriv√©e :</strong> ${constraint.time}<br>
                                    ‚è∏Ô∏è <strong>Pause :</strong> 12:00 - 13:00<br>
                                    üïï <strong>D√©part :</strong> ${endTime}<br>
                                    ‚è±Ô∏è <strong>Total :</strong> ${plannedHours.toFixed(1)}h
                                </div>
                            `;
                        } else if (constraint.type === 'long_break') {
                            plannedHours = 7;
                            const breakEnd = this.addHoursToTime(constraint.time, 2);
                            
                            daySchedule = `
                                <div style="margin: 5px 0; padding: 10px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid blue;">
                                    <strong>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</strong> - ${constraint.reason} üìö<br>
                                    üïó <strong>Arriv√©e :</strong> 08:00<br>
                                    ‚è∏Ô∏è <strong>Pause longue :</strong> ${constraint.time} - ${breakEnd}<br>
                                    üïî <strong>D√©part :</strong> 17:00<br>
                                    ‚è±Ô∏è <strong>Total :</strong> ${plannedHours.toFixed(1)}h
                                </div>
                            `;
                        } else if (constraint.type === 'short_day') {
                            plannedHours = Math.min(6, this.calculateHoursBetween('08:00', constraint.time) - 1);
                            
                            daySchedule = `
                                <div style="margin: 5px 0; padding: 10px; background: #ffe6e6; border-radius: 5px; border-left: 4px solid red;">
                                    <strong>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</strong> - ${constraint.reason} üî¥<br>
                                    üïó <strong>Arriv√©e :</strong> 08:00<br>
                                    ‚è∏Ô∏è <strong>Pause :</strong> 12:00 - 13:00<br>
                                    üïí <strong>D√©part :</strong> ${constraint.time}<br>
                                    ‚è±Ô∏è <strong>Total :</strong> ${plannedHours.toFixed(1)}h
                                </div>
                            `;
                        }
                    } else {
                        const constraintHoursLost = this.constraints.reduce((total, c) => {
                            if (c.type === 'early_leave') return total + (7 - (this.calculateHoursBetween('08:00', c.time) - 1));
                            if (c.type === 'short_day') return total + (7 - Math.min(6, this.calculateHoursBetween('08:00', c.time) - 1));
                            return total;
                        }, 0);
                        
                        const normalDaysRemaining = daysRemaining - this.constraints.filter(c => days.includes(c.day)).length;
                        const hoursToCompensate = (remainingHours + constraintHoursLost) / Math.max(1, normalDaysRemaining);
                        plannedHours = Math.max(6, Math.min(9, hoursToCompensate));
                        
                        const startTime = plannedHours > 7.5 ? '07:30' : '08:00';
                        const endTime = this.addHoursToTime(startTime, plannedHours + 1);
                        
                        daySchedule = `
                            <div style="margin: 5px 0; padding: 10px; background: #d1f2eb; border-radius: 5px; border-left: 4px solid green;">
                                <strong>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</strong> - Journ√©e normale ‚úÖ<br>
                                üïó <strong>Arriv√©e :</strong> ${startTime}<br>
                                ‚è∏Ô∏è <strong>Pause :</strong> 12:00 - 13:00<br>
                                üïí <strong>D√©part :</strong> ${endTime}<br>
                                ‚è±Ô∏è <strong>Total :</strong> ${plannedHours.toFixed(1)}h
                            </div>
                        `;
                    }
                    
                    planning += daySchedule;
                    totalPlannedHours += plannedHours;
                }
                
                planning += `<div style="margin-top: 15px; padding: 10px; background: var(--sanofi-purple); color: white; border-radius: 8px; text-align: center;">`;
                planning += `<strong>üìä Total planifi√© : ${totalPlannedHours.toFixed(1)}h / ${this.weeklyGoal}h</strong>`;
                if (totalPlannedHours >= this.weeklyGoal) {
                    planning += `<br>üéØ Objectif atteint !`;
                } else {
                    planning += `<br>‚ö†Ô∏è Il manque ${(this.weeklyGoal - totalPlannedHours).toFixed(1)}h`;
                }
                planning += '</div>';
                
                document.getElementById('planningContent').innerHTML = planning;
                document.getElementById('planningResult').style.display = 'block';
            }

            calculateHoursBetween(startTime, endTime) {
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                const startMinutes = startHour * 60 + startMin;
                const endMinutes = endHour * 60 + endMin;
                
                return (endMinutes - startMinutes) / 60;
            }

            addHoursToTime(timeStr, hours) {
                const [hour, minute] = timeStr.split(':').map(Number);
                const totalMinutes = hour * 60 + minute + (hours * 60);
                
                const newHour = Math.floor(totalMinutes / 60) % 24;
                const newMinute = totalMinutes % 60;
                
                return `${newHour.toString().padStart(2, '0')}:${newMinute.toString().padStart(2, '0')}`;
            }

            getRemainingWorkDays() {
                const today = new Date();
                const dayOfWeek = today.getDay();
                
                if (dayOfWeek === 0) return 5;
                if (dayOfWeek === 6) return 5;
                return Math.max(1, 6 - dayOfWeek);
            }

            // Calendar functionality
            openCalendar() {
                this.currentCalendarMonth = new Date();
                this.renderCalendar();
                this.openModal('calendarModal');
            }

            renderCalendar() {
                const month = this.currentCalendarMonth;
                document.getElementById('currentMonth').textContent = 
                    month.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';
                
                const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.style.fontWeight = 'bold';
                    header.style.textAlign = 'center';
                    header.style.padding = '10px';
                    header.textContent = day;
                    grid.appendChild(header);
                });
                
                const firstDay = new Date(month.getFullYear(), month.getMonth(), 1);
                const lastDay = new Date(month.getFullYear(), month.getMonth() + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = (firstDay.getDay() + 6) % 7;
                
                for (let i = 0; i < startingDayOfWeek; i++) {
                    grid.appendChild(document.createElement('div'));
                }
                
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = day;
                    
                    const dateStr = new Date(month.getFullYear(), month.getMonth(), day)
                        .toISOString().split('T')[0];
                    
                    if (data[dateStr] && data[dateStr].totalHours > 0) {
                        dayElement.classList.add('has-hours');
                        const hours = document.createElement('div');
                        hours.style.fontSize = '10px';
                        hours.textContent = this.formatHours(data[dateStr].totalHours);
                        dayElement.appendChild(hours);
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    if (dateStr === today) {
                        dayElement.classList.add('today');
                    }
                    
                    dayElement.addEventListener('click', () => this.showDayDetails(dateStr));
                    
                    grid.appendChild(dayElement);
                }
            }

            navigateCalendar(direction) {
                this.currentCalendarMonth.setMonth(this.currentCalendarMonth.getMonth() + direction);
                this.renderCalendar();
            }

            showDayDetails(dateStr) {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const dayData = data[dateStr];
                
                const detailsDiv = document.getElementById('dayDetails');
                const contentDiv = document.getElementById('dayDetailsContent');
                
                if (!dayData || !dayData.totalHours) {
                    contentDiv.innerHTML = '<p>Aucune donn√©e pour ce jour.</p>';
                } else {
                    let content = `<div style="background: var(--gray-light); padding: 15px; border-radius: 10px;">`;
                    content += `<div><strong>Date :</strong> ${new Date(dateStr).toLocaleDateString('fr-FR')}</div>`;
                    content += `<div><strong>Heures travaill√©es :</strong> ${this.formatHours(dayData.totalHours)}</div>`;
                    
                    if (dayData.startTime) {
                        content += `<div><strong>Arriv√©e :</strong> ${this.formatTime(new Date(dayData.startTime))}</div>`;
                    }
                    if (dayData.endTime) {
                        content += `<div><strong>D√©part :</strong> ${this.formatTime(new Date(dayData.endTime))}</div>`;
                    }
                    if (dayData.breakHours > 0) {
                        content += `<div><strong>Pause :</strong> ${this.formatHours(dayData.breakHours)}</div>`;
                    }
                    
                    content += '</div>';
                    contentDiv.innerHTML = content;
                }
                
                detailsDiv.style.display = 'block';
            }

            // Statistics functionality
            openStats() {
                this.updatePersonalStats();
                this.openModal('statsModal');
            }

            updatePersonalStats() {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const dates = Object.keys(data).sort();
                
                const daysWorked = dates.filter(date => data[date].totalHours > 0).length;
                document.getElementById('totalDaysWorked').textContent = daysWorked;
                
                const totalHours = dates.reduce((sum, date) => sum + (data[date].totalHours || 0), 0);
                const avgHours = daysWorked > 0 ? totalHours / daysWorked : 0;
                document.getElementById('averageDailyHours').textContent = this.formatHours(avgHours);
                
                const currentMonth = new Date().toISOString().substr(0, 7);
                const monthDates = dates.filter(date => date.startsWith(currentMonth));
                const monthHours = monthDates.reduce((sum, date) => sum + (data[date].totalHours || 0), 0);
                
                let monthlyHtml = `<div>Ce mois : ${this.formatHours(monthHours)}</div>`;
                monthlyHtml += `<div>Jours ce mois : ${monthDates.filter(date => data[date].totalHours > 0).length}</div>`;
                
                document.getElementById('monthlyProgress').innerHTML = monthlyHtml;
            }

            // Export functionality
            previewData() {
                const period = document.getElementById('exportPeriod').value;
                const data = this.getExportData(period);
                
                let preview = '<div style="max-height: 300px; overflow-y: auto;">';
                preview += '<table style="width: 100%; border-collapse: collapse;">';
                preview += '<tr style="background: var(--gray-light);"><th style="padding: 8px; border: 1px solid var(--gray-medium);">Date</th><th style="padding: 8px; border: 1px solid var(--gray-medium);">Heures</th><th style="padding: 8px; border: 1px solid var(--gray-medium);">Arriv√©e</th><th style="padding: 8px; border: 1px solid var(--gray-medium);">D√©part</th></tr>';
                
                data.forEach(row => {
                    preview += '<tr>';
                    preview += `<td style="padding: 8px; border: 1px solid var(--gray-medium);">${row.date}</td>`;
                    preview += `<td style="padding: 8px; border: 1px solid var(--gray-medium);">${row.hours}</td>`;
                    preview += `<td style="padding: 8px; border: 1px solid var(--gray-medium);">${row.start}</td>`;
                    preview += `<td style="padding: 8px; border: 1px solid var(--gray-medium);">${row.end}</td>`;
                    preview += '</tr>';
                });
                
                preview += '</table></div>';
                
                document.getElementById('previewContent').innerHTML = preview;
                document.getElementById('dataPreview').style.display = 'block';
            }

            getExportData(period) {
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const result = [];
                
                let startDate, endDate;
                const today = new Date();
                
                switch (period) {
                    case 'week':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - today.getDay() + 1);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                        break;
                    case 'month':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                    case 'custom':
                        startDate = new Date(document.getElementById('exportDateFrom').value);
                        endDate = new Date(document.getElementById('exportDateTo').value);
                        break;
                }
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data[dateStr];
                    
                    result.push({
                        date: d.toLocaleDateString('fr-FR'),
                        hours: dayData ? this.formatHours(dayData.totalHours) : '0h00',
                        start: dayData && dayData.startTime ? this.formatTime(new Date(dayData.startTime)) : '-',
                        end: dayData && dayData.endTime ? this.formatTime(new Date(dayData.endTime)) : '-'
                    });
                }
                
                return result;
            }

            downloadExcel() {
                const period = document.getElementById('exportPeriod').value;
                const data = this.getExportData(period);
                
                let csvContent = 'Date,Heures Travaill√©es,Heure Arriv√©e,Heure D√©part\n';
                data.forEach(row => {
                    csvContent += `${row.date},${row.hours},${row.start},${row.end}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `timetracker_${period}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('üìä Export r√©ussi', 'Fichier t√©l√©charg√© avec succ√®s');
            }

            // Settings functionality
            loadSettingsModal() {
                document.getElementById('dailyHours').value = this.dailyHours;
                document.getElementById('weeklyGoal').value = this.weeklyGoal;
                
                const settings = JSON.parse(localStorage.getItem('timeTrackerSettings') || '{}');
                document.getElementById('notificationsEnabled').checked = settings.notifications !== false;
            }

            saveSettings() {
                const settings = {
                    dailyHours: parseFloat(document.getElementById('dailyHours').value),
                    weeklyGoal: parseFloat(document.getElementById('weeklyGoal').value),
                    notifications: document.getElementById('notificationsEnabled').checked
                };
                
                this.dailyHours = settings.dailyHours;
                this.weeklyGoal = settings.weeklyGoal;
                
                localStorage.setItem('timeTrackerSettings', JSON.stringify(settings));
                this.updateDisplay();
                this.closeAllModals();
                this.showNotification('‚öôÔ∏è Param√®tres sauv√©s', 'Configuration mise √† jour');
            }

            // Edit times functionality
            openEditTimes() {
                this.openModal('editTimesModal');
            }

            loadDayForEdit() {
                const dateStr = document.getElementById('editDate').value;
                if (!dateStr) {
                    this.showNotification('‚ùå Erreur', 'Veuillez s√©lectionner une date');
                    return;
                }
                
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                const dayData = data[dateStr] || {};
                
                document.getElementById('editStartTime').value = '';
                document.getElementById('editEndTime').value = '';
                document.getElementById('editBreakStart').value = '';
                document.getElementById('editBreakEnd').value = '';
                
                if (dayData.startTime) {
                    const startTime = new Date(dayData.startTime);
                    document.getElementById('editStartTime').value = startTime.toTimeString().substr(0, 5);
                }
                if (dayData.endTime) {
                    const endTime = new Date(dayData.endTime);
                    document.getElementById('editEndTime').value = endTime.toTimeString().substr(0, 5);
                }
                if (dayData.breakStartTime) {
                    const breakStart = new Date(dayData.breakStartTime);
                    document.getElementById('editBreakStart').value = breakStart.toTimeString().substr(0, 5);
                }
                if (dayData.breakEndTime) {
                    const breakEnd = new Date(dayData.breakEndTime);
                    document.getElementById('editBreakEnd').value = breakEnd.toTimeString().substr(0, 5);
                }
                
                const selectedDate = new Date(dateStr).toLocaleDateString('fr-FR');
                this.showNotification('üì• Donn√©es charg√©es', `Horaires du ${selectedDate} charg√©s pour modification`);
            }

            saveEditedTimes() {
                const dateStr = document.getElementById('editDate').value;
                const startTimeStr = document.getElementById('editStartTime').value;
                const endTimeStr = document.getElementById('editEndTime').value;
                const breakStartStr = document.getElementById('editBreakStart').value;
                const breakEndStr = document.getElementById('editBreakEnd').value;
                
                if (!dateStr) {
                    this.showNotification('‚ùå Erreur', 'Veuillez s√©lectionner une date');
                    return;
                }
                
                const data = JSON.parse(localStorage.getItem('timeTrackerData') || '{}');
                
                let dayData = {};
                
                if (startTimeStr) {
                    dayData.startTime = new Date(`${dateStr}T${startTimeStr}:00`).toISOString();
                }
                if (endTimeStr) {
                    dayData.endTime = new Date(`${dateStr}T${endTimeStr}:00`).toISOString();
                }
                if (breakStartStr) {
                    dayData.breakStartTime = new Date(`${dateStr}T${breakStartStr}:00`).toISOString();
                }
                if (breakEndStr) {
                    dayData.breakEndTime = new Date(`${dateStr}T${breakEndStr}:00`).toISOString();
                }
                
                if (dayData.startTime && dayData.endTime) {
                    const start = new Date(dayData.startTime);
                    const end = new Date(dayData.endTime);
                    let totalMinutes = (end - start) / (1000 * 60);
                    
                    if (dayData.breakStartTime && dayData.breakEndTime) {
                        const breakStart = new Date(dayData.breakStartTime);
                        const breakEnd = new Date(dayData.breakEndTime);
                        const breakMinutes = (breakEnd - breakStart) / (1000 * 60);
                        totalMinutes -= breakMinutes;
                        dayData.breakHours = breakMinutes / 60;
                    }
                    
                    dayData.totalHours = Math.max(0, totalMinutes / 60);
                }
                
                data[dateStr] = dayData;
                localStorage.setItem('timeTrackerData', JSON.stringify(data));
                
                const today = new Date().toISOString().split('T')[0];
                if (dateStr === today) {
                    this.loadData();
                    this.updateDisplay();
                }
                
                this.closeAllModals();
                this.showNotification('‚úÖ Modifications sauv√©es', 'Horaires mis √† jour avec succ√®s');
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            showNotification(title, message) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--sanofi-purple);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 16px rgba(139, 90, 150, 0.3);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;
                
                notification.innerHTML = `<strong>${title}</strong><br>${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 4000);
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body: message, icon: '/favicon.ico' });
                }
            }
        }

        // CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                const themeBtn = document.getElementById('themeBtn');
                themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            
            window.timeTracker = new TimeTrackerApp();
            
            // Service Worker registration for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,Ly8gU2ltcGxlIFNlcnZpY2UgV29ya2VyIGZvciBQV0EKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBjb25zb2xlLmxvZygnU2VydmljZSBXb3JrZXIgaW5zdGFsbGVkJyk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgLy8gUGFzcyB0aHJvdWdoIGFsbCByZXF1ZXN0cwogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                .then(registration => {
                    console.log('Service Worker registered successfully:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            }
            
            // Install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                const installBtn = document.createElement('button');
                installBtn.textContent = 'üì± Installer l\'app';
                installBtn.className = 'btn';
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    z-index: 1000;
                `;
                
                installBtn.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        }
                        deferredPrompt = null;
                        document.body.removeChild(installBtn);
                    });
                });
                
                document.body.appendChild(installBtn);
                
                setTimeout(() => {
                    if (document.body.contains(installBtn)) {
                        document.body.removeChild(installBtn);
                    }
                }, 10000);
            });
            
            // Welcome message for first time users
            if (!localStorage.getItem('timeTrackerData')) {
                setTimeout(() => {
                    window.timeTracker.showNotification(
                        'üéâ Bienvenue !', 
                        'TimeTracker Pro est pr√™t ! Consultez le tutorial pour commencer.'
                    );
                }, 1000);
            }
            
            // Periodic reminders and 7h notification
            setInterval(() => {
                if (window.timeTracker.workStatus === 'working') {
                    const todayHours = window.timeTracker.calculateTodayHours();
                    
                    // Notify when reaching exactly 7 hours
                    if (todayHours >= 7 && !window.timeTracker.notified7Hours) {
                        window.timeTracker.showNotification(
                            'üéØ Objectif 7h atteint !',
                            `F√©licitations ! Vous avez travaill√© ${window.timeTracker.formatHours(todayHours)} aujourd'hui.`
                        );
                        window.timeTracker.notified7Hours = true;
                    }
                    
                    const workTime = (new Date() - window.timeTracker.startTime) / (1000 * 60 * 60);
                    
                    // Remind to take break after 4 hours
                    if (workTime > 4 && !window.timeTracker.breakStartTime && !window.timeTracker.notifiedBreak) {
                        window.timeTracker.showNotification(
                            '‚è∞ Rappel pause',
                            'Vous travaillez depuis plus de 4h. Pensez √† prendre une pause !'
                        );
                        window.timeTracker.notifiedBreak = true;
                    }
                }
                
                // Reset daily notifications at midnight
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    window.timeTracker.notified7Hours = false;
                    window.timeTracker.notifiedBreak = false;
                }
            }, 60000);
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    document.getElementById('startBtn').click();
                }
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    document.getElementById('endBtn').click();
                }
                if (e.ctrlKey && e.key === '3') {
                    e.preventDefault();
                    document.getElementById('breakStartBtn').click();
                }
                if (e.ctrlKey && e.key === '4') {
                    e.preventDefault();
                    document.getElementById('breakEndBtn').click();
                }
                if (e.key === 'Escape') {
                    window.timeTracker.closeAllModals();
                }
            });
            
            // Add weekly summary notification
            const today = new Date();
            if (today.getDay() === 5) { // Friday
                const weekHours = window.timeTracker.calculateWeekHours();
                const goal = window.timeTracker.weeklyGoal;
                
                setTimeout(() => {
                    window.timeTracker.showNotification(
                        'üìä R√©sum√© hebdomadaire',
                        `Cette semaine: ${window.timeTracker.formatHours(weekHours)}/${goal}h (${((weekHours/goal)*100).toFixed(0)}%)`
                    );
                }, 5000);
            }
        });
    </script>
</body>
</html>
